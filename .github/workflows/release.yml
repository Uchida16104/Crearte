name: Release Crearte

on:
  push:
    tags:
      - 'v*'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_tag.outputs.version }}
      version_nov: ${{ steps.get_tag.outputs.version_nov }}
    steps:
      - id: get_tag
        run: |
          echo "version=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
          echo "version_nov=${GITHUB_REF##*/v}" >> $GITHUB_OUTPUT

  build_win:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Create Winget YAML
        run: |
          mkdir -p winget
          echo "Id: Uchida16104.Crearte" > winget/crearte.yaml
          echo "Name: Crearte" >> winget/crearte.yaml
          echo "Publisher: Uchida16104" >> winget/crearte.yaml
          echo "Version: ${{ needs.setup.outputs.version_nov }}" >> winget/crearte.yaml
          echo "License: MIT" >> winget/crearte.yaml
          echo "Installers:" >> winget/crearte.yaml
          echo "  - Arch: x64" >> winget/crearte.yaml
          echo "    Url: https://github.com/Uchida16104/Crearte/releases/download/${{ needs.setup.outputs.version }}/crearte-installer.exe" >> winget/crearte.yaml
          echo "    Sha256: ENTER_SHA256_HERE" >> winget/crearte.yaml
          echo "InstallerType: exe" >> winget/crearte.yaml
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          files: winget/crearte.yaml

  build_mac:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Homebrew
        run: |
          echo "HOMEBREW_NO_INSTALL_FROM_API=1" >> $GITHUB_ENV
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH
      - name: Create Formula
        run: |
          mkdir -p formula
          echo "class Crearte < Formula" > formula/crearte.rb
          echo "  desc \"Generative graphical music score tool\"" >> formula/crearte.rb
          echo "  homepage \"https://github.com/Uchida16104/Crearte\"" >> formula/crearte.rb
          echo "  url \"https://github.com/Uchida16104/Crearte/archive/refs/tags/${{ needs.setup.outputs.version }}.tar.gz\"" >> formula/crearte.rb
          echo "  sha256 \"ENTER_SHA256_HERE\"" >> formula/crearte.rb
          echo "  license \"MIT\"" >> formula/crearte.rb
          echo "" >> formula/crearte.rb
          echo "  def install" >> formula/crearte.rb
          echo "    bin.install \"scripts/crearte-cli.sh\" => \"crearte\"" >> formula/crearte.rb
          echo "  end" >> formula/crearte.rb
          echo "end" >> formula/crearte.rb
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          files: formula/crearte.rb

  build_deb:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build .deb package
        run: |
          mkdir -p pkg/DEBIAN pkg/usr/local/bin
          echo '#!/bin/bash' > pkg/usr/local/bin/crearte
          echo 'echo "Crearte installed!"' >> pkg/usr/local/bin/crearte
          chmod +x pkg/usr/local/bin/crearte
          echo "Package: crearte" > pkg/DEBIAN/control
          echo "Version: ${{ needs.setup.outputs.version_nov }}" >> pkg/DEBIAN/control
          echo "Section: utils" >> pkg/DEBIAN/control
          echo "Priority: optional" >> pkg/DEBIAN/control
          echo "Architecture: amd64" >> pkg/DEBIAN/control
          echo "Maintainer: Uchida16104 <github@users.noreply.github.com>" >> pkg/DEBIAN/control
          echo "Description: Visual music score generator" >> pkg/DEBIAN/control
          dpkg-deb --build pkg crearte_${{ needs.setup.outputs.version_nov }}_amd64.deb
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          files: crearte_*.deb

  finalize_release:
    needs: [build_win, build_mac, build_deb]
    runs-on: ubuntu-latest
    steps:
      - name: Final release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          name: "Crearte ${{ needs.setup.outputs.version }}"
          body: |
            ✅ Automated multi-platform release of Crearte:
            - 🪟 Winget Package
            - 🍏 Homebrew Formula
            - 🐧 .deb Package
            - ☁️ GitHub Packages (optional)
          draft: false
