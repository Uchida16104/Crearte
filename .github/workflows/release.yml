name: Release Crearte

on:
  push:
    tags:
      - 'v*'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_tag.outputs.version }}
      version_nov: ${{ steps.get_tag.outputs.version_nov }}
    steps:
      - id: get_tag
        run: |
          echo "version=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
          echo "version_nov=${GITHUB_REF##*/v}" >> $GITHUB_OUTPUT

  build_win:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Create Winget YAML
        run: |
          mkdir -p winget
          cat <<EOF > winget/crearte.yaml
Id: Uchida16104.Crearte
Name: Crearte
Publisher: Uchida16104
Version: ${{ needs.setup.outputs.version_nov }}
License: MIT
Installers:
  - Arch: x64
    Url: https://github.com/Uchida16104/Crearte/releases/download/${{ needs.setup.outputs.version }}/crearte-installer.exe
    Sha256: ENTER_SHA256_HERE
InstallerType: exe
EOF
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          files: winget/crearte.yaml

  build_mac:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Homebrew
        run: |
          echo "HOMEBREW_NO_INSTALL_FROM_API=1" >> $GITHUB_ENV
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH
      - name: Create Formula
        run: |
          mkdir -p formula
          cat <<EOF > formula/crearte.rb
class Crearte < Formula
  desc "Generative graphical music score tool"
  homepage "https://github.com/Uchida16104/Crearte"
  url "https://github.com/Uchida16104/Crearte/archive/refs/tags/${{ needs.setup.outputs.version }}.tar.gz"
  sha256 "ENTER_SHA256_HERE"
  license "MIT"

  def install
    bin.install "scripts/crearte-cli.sh" => "crearte"
  end
end
EOF
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          files: formula/crearte.rb

  build_deb:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build .deb package
        run: |
          mkdir -p pkg/DEBIAN pkg/usr/local/bin
          echo '#!/bin/bash\necho "Crearte installed!"' > pkg/usr/local/bin/crearte
          chmod +x pkg/usr/local/bin/crearte
          cat <<EOF > pkg/DEBIAN/control
Package: crearte
Version: ${{ needs.setup.outputs.version_nov }}
Section: utils
Priority: optional
Architecture: amd64
Maintainer: Uchida16104 <github@users.noreply.github.com>
Description: Visual music score generator
EOF
          dpkg-deb --build pkg crearte_${{ needs.setup.outputs.version_nov }}_amd64.deb
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          files: crearte_*.deb

  finalize_release:
    needs: [build_win, build_mac, build_deb]
    runs-on: ubuntu-latest
    steps:
      - name: Final release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          name: "Crearte ${{ needs.setup.outputs.version }}"
          body: |
            âœ… Automated multi-platform release of Crearte:
            - ğŸªŸ Winget Package
            - ğŸ Homebrew Formula
            - ğŸ§ .deb Package
            - â˜ï¸ GitHub Packages (optional)
          draft: false
