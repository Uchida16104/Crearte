name: Release Crearte

on:
  push:
    tags:
      - 'v*'

jobs:

  setup:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_tag.outputs.version }}
    steps:
      - uses: actions/checkout@v3
      - id: get_tag
        run: echo "::set-output name=version::${GITHUB_REF##*/}"

  build_win:
    needs: setup
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install wingetcreate
        run: winget install --silent wingetcreate
      - name: Package with wingetcreate
        run: |
          wingetcreate new . --name Crearte --version ${{ needs.setup.outputs.version }} --publisher Uchida16104 --no-update --single-file
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          files: '*.yaml'
      - name: Publish to GitHub Packages
        run: |
          npm install
          npm run build
          npm publish

  build_mac:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Homebrew on Linux
        run: |
          sudo apt-get update
          sudo apt-get install build-essential procps curl file git
          curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh | bash
          echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> $GITHUB_ENV
      - name: Create Formula
        run: |
          brew create --no-fetch https://github.com/Uchida16104/Crearte/archive/${{ needs.setup.outputs.version }}.tar.gz --tap=Uchida16104/crearte
          cd "$(brew --repo Uchida16104/crearte)"
          sed -i '' "s/url .*/url \"https:\/\/github.com\/Uchida16104\/Crearte\/archive\/${{ needs.setup.outputs.version }}.tar.gz\"/" Crearte.rb
          sha256=$(curl -L https://github.com/Uchida16104/Crearte/archive/${{ needs.setup.outputs.version }}.tar.gz | sha256sum | cut -d' ' -f1)
          sed -i '' "s/sha256 .*/sha256 \"$sha256\"/" Crearte.rb
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git commit -am "Crearte ${{ needs.setup.outputs.version }}"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/Uchida16104/homebrew-crearte.git HEAD:main
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          files: 'Crearte.rb'

  build_deb:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build .deb
        run: |
          mkdir -p pkg/DEBIAN pkg/usr/local/bin
          cp scripts/install.sh pkg/usr/local/bin/crearte-install.sh
          echo -e "Package: crearte\nVersion: ${{ needs.setup.outputs.version }}\nSection: utils\nPriority: optional\nArchitecture: amd64\nMaintainer: Uchida16104 <>" > pkg/DEBIAN/control
          dpkg-deb --build pkg crearte_${{ needs.setup.outputs.version }}_amd64.deb
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          files: 'crearte_*.deb'

  finalize_release:
    needs: [build_win, build_mac, build_deb]
    runs-on: ubuntu-latest
    steps:
      - name: Create centralized release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          name: "Crearte ${{ needs.setup.outputs.version }}"
          body: |
            Automated release for version ${{ needs.setup.outputs.version }}.
          draft: false
