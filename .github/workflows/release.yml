name: Release Crearte

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_tag.outputs.version }}
      version_nov: ${{ steps.get_tag.outputs.version_nov }}
    steps:
      - id: get_tag
        run: |
          echo "version=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
          echo "version_nov=${GITHUB_REF##*/v}" >> $GITHUB_OUTPUT

  build_win:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Download Windows Installer
        run: |
          mkdir -p output
          curl -L -o output/crearte-installer.exe https://github.com/Uchida16104/Crearte/raw/refs/heads/main/crearte/bin/windows-amd64/bin.exe
      - name: Calculate SHA256
        id: sha
        run: echo "sha256=$(sha256sum output/crearte-installer.exe | cut -d ' ' -f 1)" >> $GITHUB_OUTPUT
      - name: Create Winget YAML
        run: |
          mkdir -p winget
          cat <<EOF > winget/crearte.yaml
Id: Uchida16104.Crearte
Name: Crearte
Publisher: Uchida16104
Version: ${{ needs.setup.outputs.version_nov }}
License: MIT
Installers:
  - Arch: x64
    Url: https://github.com/Uchida16104/Crearte/releases/download/${{ needs.setup.outputs.version }}/crearte-installer.exe
    Sha256: "${{ steps.sha.outputs.sha256 }}"
InstallerType: exe
EOF
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          files: |
            output/crearte-installer.exe
            winget/crearte.yaml

  build_mac:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Download CLI script
        run: |
          mkdir -p scripts
          curl -L -o scripts/crearte-cli.sh https://raw.githubusercontent.com/Uchida16104/Crearte/refs/heads/main/scripts/install.sh
          chmod +x scripts/crearte-cli.sh
      - name: Create tar.gz
        run: |
          mkdir -p tarbuild/crearte
          cp -r scripts tarbuild/crearte/
          tar -czf crearte.tar.gz -C tarbuild crearte
      - name: Calculate SHA256
        id: sha
        run: echo "sha256=$(shasum -a 256 crearte.tar.gz | cut -d ' ' -f 1)" >> $GITHUB_OUTPUT
      - name: Create Formula
        run: |
          mkdir -p formula
          cat <<EOF > formula/crearte.rb
class Crearte < Formula
  desc "Generative graphical music score tool"
  homepage "https://github.com/Uchida16104/Crearte"
  url "https://github.com/Uchida16104/Crearte/releases/download/${{ needs.setup.outputs.version }}/crearte.tar.gz"
  sha256 "${{ steps.sha.outputs.sha256 }}"
  license "MIT"

  def install
    bin.install "scripts/crearte-cli.sh" => "crearte"
  end
end
EOF
      - uses: actions/checkout@v3
        with:
          repository: Uchida16104/homebrew-crearte
          token: ${{ secrets.GITHUB_TOKEN }}
          path: taprepo
      - name: Update Homebrew tap
        run: |
          cp formula/crearte.rb taprepo/Formula/crearte.rb
          cd taprepo
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Update crearte.rb"
          git push origin main
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          files: crearte.tar.gz

  build_deb:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Download installer
        run: |
          mkdir -p pkg/usr/local/bin
          curl -L -o pkg/usr/local/bin/crearte https://raw.githubusercontent.com/Uchida16104/Crearte/refs/heads/main/scripts/install.sh
          chmod +x pkg/usr/local/bin/crearte
      - name: Create control file
        run: |
          mkdir -p pkg/DEBIAN
          cat <<EOF > pkg/DEBIAN/control
Package: crearte
Version: ${{ needs.setup.outputs.version_nov }}
Section: utils
Priority: optional
Architecture: amd64
Maintainer: Uchida16104 <github@users.noreply.github.com>
Description: Visual music score generator
EOF
      - name: Build .deb
        run: dpkg-deb --build pkg crearte_${{ needs.setup.outputs.version_nov }}_amd64.deb
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          files: crearte_*.deb

  finalize_release:
    needs: [build_win, build_mac, build_deb]
    runs-on: ubuntu-latest
    steps:
      - name: Final release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          name: "Crearte ${{ needs.setup.outputs.version }}"
          body: |
            ‚úÖ Automated multi-platform release of Crearte:
            - ü™ü Winget Package (.exe)
            - üçè Homebrew Tap (Formula)
            - üêß Linux DEB Package
            - ‚òÅÔ∏è GitHub Packages (WIP)
          draft: false
